#include "stack.h"

double shell(char* cmd, double arg) {
	printf(">   ");
	scanf("%s%*c", cmd);
	if (StringEqual(cmd, "push") || StringEqual(cmd, "jump") || StringEqual(cmd, "ifeq")) {
		scanf("%lf", &arg);
		return arg;
	}
	return 0;
}

void error(char* msg) { printf("error: %s\n\n", msg); }

void stack(stackT *res, double frame) {
	if ((int) frame == res->top) {
		printf("stack[top] == %d\n", (int) res->contents[res->top]);	
	}
	else {
		printf("stack[%d] == %d\n", (int) frame, (int) res->contents[(int) frame]);
	}
}

int main() {
	stackT res;
	StackInit(&res, RES_SIZE);
	char cmd[DIM2]; double arg = 0;
	int a, b;
	while (1) {
		arg = shell(cmd, arg);
		if (StringEqual(cmd, "push")) {
			StackPush(&res, arg);
			StackShow(&res);
		}
		else if (StringEqual(cmd, "pop")) {
			StackPop(&res);
			StackShow(&res);
		}
		else if (StringEqual(cmd, "add")) {
			if (res.top <= 0) {
				error("not enough frames!");
			}
			else {
				b = StackPop(&res);
				a = StackPop(&res);
				StackPush(&res, a+b);
				StackShow(&res);
			}
		}
		else if (StringEqual(cmd, "ifeq")) {
			if (res.top == -1) {
				stack(&res, arg);
			}
			else {
				stack(&res, arg);
			}
			StackShow(&res);
		}
		else if (StringEqual(cmd, "jump")) {
			if (res.top < (int) arg) {
				error("invalid frame!");
			}
			else {
				stack(&res, arg);
			}
			StackShow(&res);
		}
		else if (StringEqual(cmd, "print")) {
			if (StackIsEmpty(&res)) {
				error("stack is empty!");
			}
			else {
				stack(&res, res.top);
				StackShow(&res);
			}
		}
		else if (StringEqual(cmd, "dup")) {
			if (StackIsEmpty(&res)) {
				error("stack is empty!");
			}
			else {
				StackPush(&res, res.contents[res.top]);
				StackShow(&res);
			}
		}
		else if (StringEqual(cmd, "dec")) {
			if (StackIsEmpty(&res)) {
				error("stack is empty!");
			}
			else {
				a = StackPop(&res);
				StackPush(&res, a-1);
				StackShow(&res);
			}
		}
		else if (StringEqual(cmd, "inc")) {
			if (StackIsEmpty(&res)) {
				error("stack is empty!");
			}
			else {
				a = StackPop(&res);
				StackPush(&res, a+1);
				StackShow(&res);
			}
		}
		/*
		else if (StringEqual(cmd, "while")) {
			if (StackIsEmpty(&res)) {
				error("stack is empty!");
			}
			else {
				a = res.contents[res.top];
				while (a != 0) {
					
				}
			}
		}
		*/
		else {
			error("unknown command!");
		}
		//		printf("\n");
	}
}
